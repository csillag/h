(function(){window.DomTextMapper=function(){function t(){this.setRealRoot()}return t.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},t.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},t.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},t.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},t.prototype.getAllPaths=function(){return this.saveSelection(),this.allPaths=this.collectPathsForNode(this.pathStartNode),this.restoreSelection(),this.allPaths},t.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},t.prototype.selectPath=function(t,e){return null==e&&(e=!1),this.selectNode(this.allPaths[t].node,e)},t.prototype.scan=function(t,e){var n;return null==t&&(t=null),null==e&&(e=!1),null==t&&(t=this.getDefaultPath()),t!==this.scannedPath||e?(n=this.allPaths[t].node,this.mappings={},this.saveSelection(),this.collectStrings(n,t,null,0,0),this.restoreSelection(),this.scannedPath=t,this.corpus=this.mappings[t].pathInfo.content,null):void 0},t.prototype.getRangeForPath=function(t){return this.mappings[t]},t.prototype.getMappingsForRange=function(t,e,n,o){var r,s,a,i,l,h,d,u,c,p,f,g,m,N,y,S,w=this;if(null==n&&(n=null),null==o&&(o=!1),null==t||null==e)throw Error("start and end is required!");if(null!=n)this.scan(n,o);else if(null==this.scannedPath)throw Error("Can not run getMappingsFor() without existing mappings. Either supply a path to scan, or call scan() beforehand!");d=[],S=this.mappings;for(u in S)h=S[u],h.atomic&&this.regions_overlap(h.start,h.end,t,e)&&function(n){var o,r;return r={element:n},o=n.start>=t&&e>=n.end,o?(r.full=!0,r.wanted=n.content):n.start>=t?(r.end=e-n.start,r.wanted=n.pathInfo.content.substr(0,r.end)):e>=n.end?(r.start=t-n.start,r.wanted=n.pathInfo.content.substr(r.start)):(r.start=t-n.start,r.end=e-n.start,r.wanted=n.pathInfo.content.substr(r.start,r.end-r.start)),w.computeSourcePositions(r),r.yields=n.pathInfo.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected),d.push(r)}(h);if(0===d.length)throw Error("No matches found!");return c=this.rootWin.document.createRange(),g=d[0],m=g.element.pathInfo.node,y=g.element.pathInfo.path,N=g.startCorrected,g.full?(c.setStartBefore(m),f=y):(c.setStart(m,N),f=y+":"+N),s=d[d.length-1],a=s.element.pathInfo.node,l=s.element.pathInfo.path,i=s.endCorrected,s.full?(c.setEndAfter(a),r=l):(c.setEnd(a,i),r=l+":"+i),p={nodes:d,range:c,rangeInfo:{startPath:y,startOffset:N,startInfo:f,endPath:l,endOffset:i,endInfo:r}}},t.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},t.prototype.getPathTo=function(t){var e,n,o;for(o="";t!==this.rootNode;){for(e=0,n=t;n;)n.nodeName===t.nodeName&&e++,n=n.previousSibling;o=this.getProperNodeName(t)+(e>1?"["+e+"]":"")+"/"+o,t=t.parentNode}return o=(null!=this.rootNode.ownerDocument?"./":"/")+o,o=o.replace(/\/$/,"")},t.prototype.collectPathsForNode=function(t,e){var n,o,r,s;if(null==e&&(e={}),s=this.getPathTo(t),o=this.getNodeContent(t,!1),o.length&&(e[s]={path:s,node:t,content:o,length:o.length}),t.hasChildNodes)for(n=t.childNodes,r=0;n.length>r;)this.collectPathsForNode(n[r],e),r++;return e},t.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},t.prototype.regions_overlap=function(t,e,n,o){return o>t&&e>n},t.prototype.saveSelection=function(){var t,e,n,o,r;for(e=this.rootWin.getSelection(),t=n=0,o=e.rangeCount;o>=0?o>n:n>o;t=o>=0?++n:--n)this.oldRanges=e.getRangeAt(t);switch(e.rangeCount){case 0:return null!=(r=this.oldRanges)?r:this.oldRanges=[];case 1:return this.oldRanges=[this.oldRanges]}},t.prototype.restoreSelection=function(){var t,e,n,o,r,s;for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.oldRanges,s=[],n=0,o=r.length;o>n;n++)t=r[n],s.push(e.addRange(t));return s},t.prototype.selectNode=function(t,e){var n,o,r;if(null==e&&(e=!1),o=this.rootWin.getSelection(),o.removeAllRanges(),n=this.rootWin.document.createRange(),n.setStartBefore(t),n.setEndAfter(t),o.addRange(n),e){for(r=t;null==r.scrollIntoViewIfNeeded;)r=r.parentNode;r.scrollIntoViewIfNeeded()}return o},t.prototype.getNodeSelectionText=function(t,e){var n,o;return null==e&&(e=!0),e&&this.saveSelection(),n=this.selectNode(t),o=(""+n).trim().replace(/\n/g," ").replace(/[ ][ ]+/g," "),e&&this.restoreSelection(),o},t.prototype.computeSourcePositions=function(t){var e,n,o,r,s,a,i,l,h,d;for(d=t.element.pathInfo.node.data.replace(/\n/g," "),s=t.element.pathInfo.content,r=null!=t.start?t.start:0,n=null!=t.end?t.end:s.length,l=0,o=0;null==h||null==i;)a=d[l],e=s[o],a===e&&(o===r&&(h=l),o++,o===n&&(i=l+1)),l++;return t.startCorrected=h,t.endCorrected=i,null},t.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},t.prototype.collectStrings=function(t,e,n,o,r){var s,a,i,l,h,d,u,c,p,f,g,m,N,y;if(null==n&&(n=null),null==o&&(o=0),null==r&&(r=0),g=this.allPaths[e],h=null!=g?g.content:void 0,null==h||""===h)return r;if(N=null!=n?n.indexOf(h,r):r,-1===N)return r;if(d=N+h.length,s=!t.hasChildNodes(),this.mappings[e]={pathInfo:g,start:o+N,end:o+d,atomic:s},!s)for(l=t.childNodes,u=0,m=0,y={};l.length>u;)a=l[u],p=this.getProperNodeName(a),f=y[p],c=null!=f?f+1:1,y[p]=c,i=e+"/"+p+(c>1?"["+c+"]":""),m=this.collectStrings(a,i,h,o+N,m),u++;return d},t}()}).call(this),function(){angular.module("domTextMapper",[]).factory("domTextMapper",function(){return{getInstance:function(){return new DomTextMapper}}})}.call(this);